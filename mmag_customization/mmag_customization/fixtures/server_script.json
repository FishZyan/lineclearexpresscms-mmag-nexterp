[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-13 13:53:51.122202",
  "module": "Mmag Customization",
  "name": "Purchase Invoice Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "doc.custom_extra_approval = 0\r\n\r\nlinked_pos = { pi_item.purchase_order for pi_item in doc.items if pi_item.purchase_order }\r\n\r\nfor count, pi_item in enumerate(doc.items, start=1):\r\n\r\n    if not pi_item.purchase_order:\r\n        # üîë If NO purchase order ‚Üí require extra approval\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No Purchase Order reference for item {pi_item.item_code} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    po_item = frappe.db.get_value(\r\n        \"Purchase Order Item\",\r\n        {\r\n            \"parent\": pi_item.purchase_order,\r\n            \"item_code\": pi_item.item_code,\r\n            \"idx\": pi_item.idx\r\n        },\r\n        [\"amount\", \"rate\"],\r\n        as_dict=True\r\n    )\r\n\r\n    if not po_item:\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No PO line found for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        continue\r\n\r\n    if round(pi_item.amount or 0, 2) != round(po_item.amount or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Amount mismatch for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    if round(pi_item.rate or 0, 2) != round(po_item.rate or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Rate mismatch for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n# ‚úÖ Check if the item counts match\r\nfor po in linked_pos:\r\n    pi_items_count = len([pi_item for pi_item in doc.items if pi_item.purchase_order == po])\r\n    po_items_count = frappe.db.count(\"Purchase Order Item\", {\"parent\": po})\r\n\r\n    if pi_items_count != po_items_count:\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Item count mismatch for PO {po}: PI has {pi_items_count}, PO has {po_items_count}.\"\r\n        )\r\n        break\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-13 13:53:44.041923",
  "module": "Mmag Customization",
  "name": "Purchase Receipt Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "doc.custom_extra_approval = 0\r\n\r\nlinked_pos = { pi_item.purchase_order for pi_item in doc.items if pi_item.purchase_order }\r\n\r\nfor count, pi_item in enumerate(doc.items, start=1):\r\n\r\n    if not pi_item.purchase_order:\r\n        # üîë If NO purchase order ‚Üí require extra approval\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No Purchase Order reference for item {pi_item.item_code} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    po_item = frappe.db.get_value(\r\n        \"Purchase Order Item\",\r\n        {\r\n            \"parent\": pi_item.purchase_order,\r\n            \"item_code\": pi_item.item_code,\r\n            \"idx\": pi_item.idx\r\n        },\r\n        [\"amount\", \"rate\"],\r\n        as_dict=True\r\n    )\r\n\r\n    if not po_item:\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No PO line found for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        continue\r\n\r\n    if round(pi_item.amount or 0, 2) != round(po_item.amount or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Amount mismatch for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    if round(pi_item.rate or 0, 2) != round(po_item.rate or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Rate mismatch for {pi_item.item_code} in PO {pi_item.purchase_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n# ‚úÖ Check if the item counts match\r\nfor po in linked_pos:\r\n    pi_items_count = len([pi_item for pi_item in doc.items if pi_item.purchase_order == po])\r\n    po_items_count = frappe.db.count(\"Purchase Order Item\", {\"parent\": po})\r\n\r\n    if pi_items_count != po_items_count:\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Item count mismatch for PO {po}: PI has {pi_items_count}, PO has {po_items_count}.\"\r\n        )\r\n        break\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-13 13:53:33.099511",
  "module": "Mmag Customization",
  "name": "Sales Invoice Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "doc.custom_extra_approval = 0\r\n\r\nlinked_pos = { pi_item.sales_order for pi_item in doc.items if pi_item.sales_order }\r\n\r\nfor count, pi_item in enumerate(doc.items, start=1):\r\n\r\n    if not pi_item.sales_order:\r\n        # üîë If NO purchase order ‚Üí require extra approval\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No Sales Order reference for item {pi_item.item_code} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    po_item = frappe.db.get_value(\r\n        \"Sales Order Item\",\r\n        {\r\n            \"parent\": pi_item.sales_order,\r\n            \"item_code\": pi_item.item_code,\r\n            \"idx\": pi_item.idx\r\n        },\r\n        [\"amount\", \"rate\"],\r\n        as_dict=True\r\n    )\r\n\r\n    if not po_item:\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No SO line found for {pi_item.item_code} in SO {pi_item.sales_order} (Row #{count}).\"\r\n        )\r\n        continue\r\n\r\n    if round(pi_item.amount or 0, 2) != round(po_item.amount or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Amount mismatch for {pi_item.item_code} in SO {pi_item.sales_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    if round(pi_item.rate or 0, 2) != round(po_item.rate or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Rate mismatch for {pi_item.item_code} in SO {pi_item.sales_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n# ‚úÖ Check if the item counts match\r\nfor po in linked_pos:\r\n    pi_items_count = len([pi_item for pi_item in doc.items if pi_item.sales_order == po])\r\n    po_items_count = frappe.db.count(\"Sales Order Item\", {\"parent\": po})\r\n\r\n    if pi_items_count != po_items_count:\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Item count mismatch for SO {po}: SI has {pi_items_count}, SO has {po_items_count}.\"\r\n        )\r\n        break\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-13 13:53:38.892079",
  "module": "Mmag Customization",
  "name": "Delivery Note Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "doc.custom_extra_approval = 0\r\n\r\nlinked_pos = { pi_item.against_sales_order for pi_item in doc.items if pi_item.against_sales_order }\r\n\r\nfor count, pi_item in enumerate(doc.items, start=1):\r\n\r\n    if not pi_item.against_sales_order:\r\n        # üîë If NO purchase order ‚Üí require extra approval\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No Sales Order reference for item {pi_item.item_code} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    po_item = frappe.db.get_value(\r\n        \"Sales Order Item\",\r\n        {\r\n            \"parent\": pi_item.against_sales_order,\r\n            \"item_code\": pi_item.item_code,\r\n            \"idx\": pi_item.idx\r\n        },\r\n        [\"amount\", \"rate\"],\r\n        as_dict=True\r\n    )\r\n\r\n    if not po_item:\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è No SO line found for {pi_item.item_code} in SO {pi_item.against_sales_order} (Row #{count}).\"\r\n        )\r\n        continue\r\n\r\n    if round(pi_item.amount or 0, 2) != round(po_item.amount or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Amount mismatch for {pi_item.item_code} in SO {pi_item.against_sales_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n    if round(pi_item.rate or 0, 2) != round(po_item.rate or 0, 2):\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Rate mismatch for {pi_item.item_code} in SO {pi_item.against_sales_order} (Row #{count}).\"\r\n        )\r\n        break\r\n\r\n# ‚úÖ Check if the item counts match\r\nfor po in linked_pos:\r\n    pi_items_count = len([pi_item for pi_item in doc.items if pi_item.against_sales_order == po])\r\n    po_items_count = frappe.db.count(\"Sales Order Item\", {\"parent\": po})\r\n\r\n    if pi_items_count != po_items_count:\r\n        doc.custom_extra_approval = 1\r\n        frappe.msgprint(\r\n            f\"‚ö†Ô∏è Item count mismatch for SO {po}: SI has {pi_items_count}, SO has {po_items_count}.\"\r\n        )\r\n        break\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-18 11:13:45.842568",
  "module": "Mmag Customization",
  "name": "Email Notification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Order",
  "script": "if doc.workflow_state == \"Approve By Product Manager\":\r\n    for row in doc.custom_user_notification:\r\n        if row.user:\r\n            frappe.get_doc({\r\n                \"doctype\": \"Notification Log\",\r\n                \"subject\": f\"Require Approval {doc.name}\",\r\n                \"email_content\": \"This document requires your approval.\",\r\n                \"for_user\": row.user,\r\n                \"type\": \"Alert\",\r\n                \"document_type\": doc.doctype,\r\n                \"document_name\": doc.name\r\n            }).insert(ignore_permissions=True)\r\n            \r\n            frappe.sendmail(\r\n                recipients=row.user,\r\n                subject=f\"Require Approval {doc.name}\",\r\n                message=\"Require Approval\"\r\n            )\r\n",
  "script_type": "DocType Event"
 }
]